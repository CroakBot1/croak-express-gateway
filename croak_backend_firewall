// === CROAK BOT BACKEND ‚Äì GUARDIAN MODE V2 üõ°Ô∏èüê∏ ===
const express = require('express');
const crypto = require('crypto');
const helmet = require('helmet');
const rateLimit = require('express-rate-limit');
const axios = require('axios');
const fs = require('fs');
const app = express();
const PORT = process.env.PORT || 3000;

const SHARED_SECRET = 'croak_secret_98765';
const DISCORD_WEBHOOK = 'https://discord.com/api/webhooks/your_webhook_here';
const BLOCKED_IPS = {};
const LOG_FILE = 'guardian_logs.json';

app.use(express.json());
app.use(helmet());

const limiter = rateLimit({
  windowMs: 15 * 60 * 1000,
  max: 100,
  message: '‚ö†Ô∏è Too many requests. Slow down.'
});
app.use(limiter);

function looksSuspicious(input) {
  return typeof input === 'string' && /<script|eval\(|SELECT|UNION|INSERT|\$\{|\*\*|=>/i.test(input);
}

function analyzeThreat(req) {
  const { licenseKey, signal, data, signature } = req.body;
  let threatScore = 0;
  if (!licenseKey || typeof licenseKey !== 'string') threatScore += 2;
  if (!signature) threatScore += 5;
  if (looksSuspicious(signal)) threatScore += 10;
  if (typeof data === 'string' && looksSuspicious(data)) threatScore += 5;
  if (!['BUY','SELL','WAIT','TRAP'].includes(signal)) threatScore += 3;
  return threatScore;
}

function isValidSignature(payload, signature) {
  const hash = crypto.createHmac('sha256', SHARED_SECRET)
    .update(JSON.stringify(payload)).digest('hex');
  return signature === hash;
}

function sendDiscordAlert(msg) {
  axios.post(DISCORD_WEBHOOK, { content: msg }).catch(console.error);
}

function logRequest(req, threatScore, blocked) {
  const log = {
    timestamp: new Date().toISOString(),
    ip: req.ip,
    signal: req.body.signal,
    score: threatScore,
    blocked: blocked,
    reason: blocked ? 'Threat detected' : 'Passed'
  };
  console.log('üìù Log:', log);
  fs.appendFileSync(LOG_FILE, JSON.stringify(log) + '\n');
}

app.post('/croak/execute', (req, res) => {
  const ip = req.ip;
  const { signal, data, licenseKey, signature } = req.body;
  const threat = analyzeThreat(req);

  if (!isValidSignature({ signal, data }, signature)) {
    sendDiscordAlert(`üö® Signature Mismatch: IP ${ip}`);
    return res.status(403).json({ error: '‚ùå Invalid Signature' });
  }

  if (BLOCKED_IPS[ip] && Date.now() < BLOCKED_IPS[ip]) {
    return res.status(403).json({
      error: '‚õî IP temporarily blocked',
      retryAfter: new Date(BLOCKED_IPS[ip]).toISOString()
    });
  }

  if (threat >= 10) {
    BLOCKED_IPS[ip] = Date.now() + 24 * 60 * 60 * 1000;
    sendDiscordAlert(`üö® IP Blocked: ${ip}, Threat Score: ${threat}`);
    logRequest(req, threat, true);
    return res.status(403).json({
      error: '‚ö†Ô∏è Suspicious behavior detected.',
      threatScore: threat
    });
  }

  logRequest(req, threat, false);
  res.json({ success: true, message: '‚úÖ Signal Accepted' });
});

app.get('/', (req, res) => {
  res.send('üü¢ Croak Guardian Backend is Online');
});

app.listen(PORT, () => console.log(`üü¢ CROAK GUARDIAN SERVER RUNNING ON PORT ${PORT}`));
